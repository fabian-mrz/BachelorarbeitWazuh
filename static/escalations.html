<!DOCTYPE html>
<html>

<head>
    <title>Escalation Settings</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .phase-container {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .contact-select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
        }

        .phase-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delay-input {
            width: 80px;
            padding: 5px;
        }

        .selected-contacts {
            margin: 10px 0;
        }

        .contact-chip {
            background: #e0e0e0;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 15px;
            display: inline-block;
        }

        .remove-contact {
            margin-left: 5px;
            cursor: pointer;
            color: red;
        }

        .logout-btn {
            background-color: #ff4444;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            margin-left: auto;
            transition: background-color 0.3s;
        }

        .logout-btn:hover {
            background-color: #cc0000;
        }

        .nav-container {
            display: flex;
            align-items: center;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="nav-link">Incidents</a>
            <a href="escalations.html" class="nav-link">Escalation Settings</a>
            <a href="contacts.html" class="nav-link">Contacts</a>
            <a href="suppressions.html" class="nav-link">Suppressions</a>
            <a href="settings.html" class="nav-link">Settings</a>
            <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
    </nav>

    <div class="container">
        <h2>Escalation Settings</h2>

        <!-- Default Escalation Settings -->
        <div class="settings-section">
            <h3>Default Escalation Process</h3>
            <div id="default-phases">
                <!-- Phases will be added here -->
            </div>
        </div>

        <!-- Rule-specific Settings -->
        <div class="settings-section">
            <h3>Rule-specific Escalations</h3>
            <button onclick="addNewRule()" class="add-btn">Add New Rule</button>
            <div id="rule-phases">
                <!-- Rule phases will be added here -->
            </div>
        </div>

        <button onclick="saveEscalations()" class="save-btn">Save Changes</button>
    </div>

    <script>
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        let escalationsData = {
            default: {
                phases: [
                    { type: 'email', contacts: [], delay: 0 },
                    { type: 'phone', contacts: [], delay: 30 }
                ]
            },
            rules: {}
        };
        let contactsData = {};

        async function loadContacts() {
            try {
                const headers = getAuthHeaders();
                console.log('Contact request headers:', headers);

                const response = await fetch('/api/contacts', {
                    method: 'GET',
                    headers: headers
                });

                console.log('Contacts response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Contacts error response:', errorText);

                    if (response.status === 401 || response.status === 403) {
                        console.log('Authentication failed - redirecting to login');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('Contacts data received:', data);

                if (!data) {
                    throw new Error('No contacts data received');
                }

                contactsData = data;
                return contactsData;

            } catch (error) {
                console.error('Error loading contacts:', error);
                showError(`Failed to load contacts: ${error.message}`);
                throw error;
            }
        }

        async function loadEscalations() {
            try {
                const headers = getAuthHeaders();
                console.log('Escalations request headers:', headers);

                const response = await fetch('/api/escalations', {
                    method: 'GET',
                    headers: headers
                });

                console.log('Escalations response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Escalations error response:', errorText);

                    if (response.status === 401 || response.status === 403) {
                        console.log('Authentication failed - redirecting to login');
                        localStorage.removeItem('token');
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('Escalations data received:', data);

                if (!data) {
                    throw new Error('No escalations data received');
                }

                escalationsData = data;
                renderEscalations();
                return escalationsData;

            } catch (error) {
                console.error('Error loading escalations:', error);
                showError(`Failed to load escalations: ${error.message}`);
                throw error;
            }
        }

        function createPhaseHTML(phase, phaseIndex, ruleId = 'default') {
            const contactOptions = Object.entries(contactsData.contacts)
                .map(([id, contact]) => `
                    <option value="${id}">${contact.name} (${phase.type === 'email' ? contact.email : contact.phone})</option>
                `).join('');

            return `
                <div class="phase-container">
                    <div class="phase-header">
                        <h4>Phase ${phaseIndex + 1} - ${phase.type.charAt(0).toUpperCase() + phase.type.slice(1)}</h4>
                        <div>
                            Delay: <input type="number" 
                                        value="${phase.delay}" 
                                        class="delay-input"
                                        onchange="updateDelay('${ruleId}', ${phaseIndex}, this.value)"> minutes
                        </div>
                    </div>
                    <select class="contact-select" 
                            onchange="addContact('${ruleId}', ${phaseIndex}, this.value)">
                        <option value="">Select contact...</option>
                        ${contactOptions}
                    </select>
                    <div class="selected-contacts">
                        ${phase.contacts.map(contactId => {
                const contact = contactsData.contacts[contactId];
                return `
                                <span class="contact-chip">
                                    ${contact.name}
                                    <span class="remove-contact" 
                                          onclick="removeContact('${ruleId}', ${phaseIndex}, '${contactId}')">Ã—</span>
                                </span>
                            `;
            }).join('')}
                    </div>
                </div>
            `;
        }

        function renderEscalations() {
            // Render default phases
            const defaultContainer = document.getElementById('default-phases');
            defaultContainer.innerHTML = escalationsData.default.phases
                .map((phase, index) => createPhaseHTML(phase, index))
                .join('');

            // Render rule-specific phases
            const rulesContainer = document.getElementById('rule-phases');
            rulesContainer.innerHTML = Object.entries(escalationsData.rules)
                .map(([ruleId, rule]) => `
                    <div class="settings-section">
                        <h4>Rule ${ruleId}</h4>
                        ${rule.phases.map((phase, index) =>
                    createPhaseHTML(phase, index, ruleId)
                ).join('')}
                        <button onclick="deleteRule('${ruleId}')" class="delete-btn">Delete Rule</button>
                    </div>
                `).join('');
        }

        function addContact(ruleId, phaseIndex, contactId) {
            if (!contactId) return;

            const target = ruleId === 'default' ?
                escalationsData.default :
                escalationsData.rules[ruleId];

            if (!target.phases[phaseIndex].contacts.includes(contactId)) {
                target.phases[phaseIndex].contacts.push(contactId);
                renderEscalations();
            }
        }

        function removeContact(ruleId, phaseIndex, contactId) {
            const target = ruleId === 'default' ?
                escalationsData.default :
                escalationsData.rules[ruleId];

            target.phases[phaseIndex].contacts = target.phases[phaseIndex].contacts
                .filter(id => id !== contactId);
            renderEscalations();
        }

        function updateDelay(ruleId, phaseIndex, delay) {
            const target = ruleId === 'default' ?
                escalationsData.default :
                escalationsData.rules[ruleId];

            target.phases[phaseIndex].delay = parseInt(delay) || 0;
        }

        function addNewRule() {
            const ruleId = prompt("Enter Rule ID:");
            if (ruleId) {
                escalationsData.rules[ruleId] = {
                    phases: [
                        { type: 'email', contacts: [], delay: 0 },
                        { type: 'phone', contacts: [], delay: 30 }
                    ]
                };
                renderEscalations();
            }
        }

        function deleteRule(ruleId) {
            if (confirm(`Delete rule ${ruleId}?`)) {
                delete escalationsData.rules[ruleId];
                renderEscalations();
            }
        }

        async function saveEscalations() {
            try {
                const response = await fetch('/api/escalations', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(escalationsData)
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        window.location.href = '/login.html';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                alert('Escalations saved successfully!');
            } catch (error) {
                alert('Error saving escalations');
                console.error(error);
            }
        }

        function setActiveNavLink() {
            const currentPage = window.location.pathname.split('/').pop() || 'index.html';
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.getAttribute('href') === currentPage) {
                    link.classList.add('active');
                }
            });
        }
        document.getElementById('logoutBtn').addEventListener('click', function () {
            // Clear authentication token
            localStorage.removeItem('token');
            // Redirect to login page
            window.location.href = 'login.html';
        });

        // Helper function to show errors
        function showError(message) {
            const errorDiv = document.getElementById('error-message') || document.createElement('div');
            errorDiv.id = 'error-message';
            errorDiv.style.color = 'red';
            errorDiv.textContent = message;
            document.querySelector('main').prepend(errorDiv);
        }

        window.onload = async function () {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/login.html';
                return;
            }
            await loadContacts();
            await loadEscalations();
            setActiveNavLink();
        };
    </script>
</body>

</html>