<!DOCTYPE html>
<html>

<head>
    <title>Incident Details</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .rule-time {
            color: #666;
            font-size: 0.9em;
            margin: 5px 0;
            padding: 3px 0;
            border-top: 1px solid #eee;
        }

        .details-table {
            width: 100%;
            border-collapse: collapse;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .details-table th {
            background-color: #4CAF50;
            color: white;
            text-align: left;
            padding: 12px;
        }

        .details-table td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }

        .back-btn,
        .btn,
        .download-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 4px;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }

        .download-btn {
            background-color: #2196F3;
        }

        .download-btn:hover {
            background-color: #1976D2;
        }

        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }

        .criterion,
        .suppression-rule,
        .time-range {
            margin: 15px 0;
        }

        #date-range-inputs {
            margin-top: 10px;
        }

        .rule-criteria {
            margin: 5px 0;
            font-family: monospace;
        }

        .operator-select {
            margin: 0 10px;
        }
    </style>
    <script>
        let sampleEvent = null; // Will be populated from incident details

        function toggleTimeRange() {
            const isPermanent = document.getElementById('permanent-checkbox').checked;
            const dateInputs = document.getElementById('date-range-inputs');
            dateInputs.style.display = isPermanent ? 'none' : 'block';
        }

        async function loadIncidentDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');

            const response = await fetch('/incidents/');
            const incidents = await response.json();
            const incident = incidents[id];

            if (!incident) {
                document.body.innerHTML = '<h1>Incident not found</h1>';
                return;
            }

            const details = JSON.parse(incident.description);
            const detailsTable = document.getElementById('details');

            // Add basic incident info
            addRow('Incident ID', id);
            addRow('Timestamp', incident.timestamp);
            addRow('Status', incident.acknowledged ? 'Acknowledged' : incident.escalated ? 'Escalated' : 'Pending');

            // Add CSV download if available
            if (details.csv_path) {
                addRow('CSV Export', `<a href="${details.csv_path}" class="download-btn" download>Download Events CSV</a>`);
            }

            // Add parsed details
            for (const [key, value] of Object.entries(details)) {
                if (key === 'csv_path') continue; // Skip csv_path as we handled it above
                if (key === 'sample_event') {
                    addRow(key, `<pre>${JSON.stringify(value, null, 2)}</pre>`);
                } else if (Array.isArray(value)) {
                    addRow(key, value.join(', '));
                } else {
                    addRow(key, value);
                }
            }

            // Populate sampleEvent for suppression rule builder
            if (details.sample_event) {
                sampleEvent = details.sample_event;
            }
        }

        function addRow(key, value) {
            const table = document.getElementById('details');
            const row = table.insertRow();
            row.innerHTML = `
                <td><strong>${key}</strong></td>
                <td>${value}</td>
            `;
        }

        function buildFieldOptions(obj, prefix = '') {
            let options = [];
            for (const [key, value] of Object.entries(obj)) {
                if (typeof value === 'object' && value !== null && !Array.isArray(value)) {
                    options = options.concat(buildFieldOptions(value, prefix ? `${prefix}.${key}` : key));
                } else {
                    options.push(prefix ? `${prefix}.${key}` : key);
                }
            }
            return options;
        }

        function createCriterionElement(existingValues = null) {
            const div = document.createElement('div');
            div.className = 'criterion';

            const fields = buildFieldOptions(sampleEvent);
            const operators = ['equals', 'contains', 'startsWith', 'endsWith'];

            const selectedField = existingValues?.field || fields[0];
            const selectedOp = existingValues?.operator || 'equals';
            const value = existingValues?.value || '';

            div.innerHTML = `
                <select class="field-select" onchange="updateValueInput(this)">
                    ${fields.map(f => `<option value="${f}" ${f === selectedField ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
                <select class="operator-select">
                    ${operators.map(op => `<option value="${op}" ${op === selectedOp ? 'selected' : ''}>${op}</option>`).join('')}
                </select>
                <input type="text" class="value-input" value="${value}" placeholder="Value">
                <select class="boolean-op">
                    <option value="AND">AND</option>
                    <option value="OR">OR</option>
                </select>
                <button onclick="removeCriterion(this)" class="btn">Remove</button>
            `;

            return div;
        }

        function updateValueInput(fieldSelect) {
            const field = fieldSelect.value;
            const valueInput = fieldSelect.parentElement.querySelector('.value-input');
            const sampleValue = getFieldValue(sampleEvent, field);

            if (sampleValue !== undefined) {
                valueInput.value = sampleValue;
            }
        }

        function getFieldValue(obj, path) {
            return path.split('.').reduce((o, i) => o?.[i], obj);
        }

        function addCriterion() {
            const container = document.getElementById('criteria-container');
            container.appendChild(createCriterionElement());
        }

        function removeCriterion(button) {
            button.parentElement.remove();
        }

        async function saveSuppressionRule() {
            const isPermanent = document.getElementById('permanent-checkbox').checked;
            const timeRange = isPermanent
                ? { permanent: true }
                : {
                    start: document.getElementById('range-start').value,
                    end: document.getElementById('range-end').value,
                    permanent: false
                };

            const rule = {
                id: Date.now().toString(),
                created: new Date().toISOString(),
                criteria: buildCriteria(),
                timeRange
            };


            await fetch('/api/suppressions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rule)
            });

            loadSuppressionRules();
            document.getElementById('criteria-container').innerHTML = '';
        }

        async function loadSuppressionRules() {
            const response = await fetch('/api/suppressions');
            const rules = await response.json();

            const listEl = document.getElementById('suppression-list');
            listEl.innerHTML = '';

            for (const [id, rule] of Object.entries(rules)) {
                const ruleEl = document.createElement('div');
                ruleEl.className = 'suppression-rule';

                // Format time range display
                let timeRangeText = '';
                if (rule.timeRange?.permanent) {
                    timeRangeText = 'Permanent';
                } else if (rule.timeRange?.start && rule.timeRange?.end) {
                    timeRangeText = `Valid from ${new Date(rule.timeRange.start).toLocaleDateString()} to ${new Date(rule.timeRange.end).toLocaleDateString()}`;
                }

                ruleEl.innerHTML = `
            <h4>Rule ${id}</h4>
            <div class="rule-criteria">
                ${rule.criteria.map(c => `
                    ${c.field} ${c.operator} "${c.value}"
                    ${c.booleanOperator ? `<span>${c.booleanOperator}</span>` : ''}
                `).join('<br>')}
            </div>
            <div class="rule-time">
                <strong>Time Range:</strong> ${timeRangeText}
            </div>
            <button onclick="editRule('${id}')" class="btn">Edit</button>
            <button onclick="deleteRule('${id}')" class="btn">Delete</button>
        `;
                listEl.appendChild(ruleEl);
            }
        }

        async function editRule(ruleId) {
            try {
                const response = await fetch(`/api/suppressions/${ruleId}`);
                if (!response.ok) throw new Error('Failed to fetch rule');

                const rule = await response.json();

                // Clear existing criteria
                document.getElementById('criteria-container').innerHTML = '';

                // Load criteria
                rule.criteria.forEach(criterion => {
                    const el = createCriterionElement(criterion);
                    document.getElementById('criteria-container').appendChild(el);
                });

                // Set time range
                document.getElementById('permanent-checkbox').checked = rule.timeRange?.permanent || false;
                toggleTimeRange();

                if (!rule.timeRange?.permanent) {
                    document.getElementById('range-start').value = rule.timeRange?.start || '';
                    document.getElementById('range-end').value = rule.timeRange?.end || '';
                }

                // Update save button to handle update
                const saveBtn = document.querySelector('#suppression-builder button:last-child');
                saveBtn.textContent = 'Update Rule';
                saveBtn.onclick = () => updateRule(ruleId);
            } catch (error) {
                console.error('Error editing suppression rule:', error);
                alert('Failed to load suppression rule');
            }
        }

        async function deleteRule(ruleId) {
            if (confirm('Are you sure you want to delete this rule?')) {
                await fetch(`/api/suppressions/${ruleId}`, {
                    method: 'DELETE'
                });
                loadSuppressionRules();
            }
        }

        function toggleDateInputs() {
            const timeRangeType = document.getElementById('time-range-type').value;
            const dateInputs = document.getElementById('date-range-inputs');

            if (timeRangeType === 'permanent') {
                dateInputs.style.display = 'none';
            } else {
                dateInputs.style.display = 'block';
                // Set default dates if empty
                if (!document.getElementById('range-start').value) {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('range-start').value = today;
                    document.getElementById('range-end').value = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                }
            }
        }

        function buildCriteria() {
            const criteria = [];
            const elements = document.querySelectorAll('.criterion');

            elements.forEach((el, index) => {
                const field = el.querySelector('.field-select').value;
                const operator = el.querySelector('.operator-select').value;
                const value = el.querySelector('.value-input').value;
                const booleanOp = el.querySelector('.boolean-op').value;

                criteria.push({
                    field,
                    operator,
                    value,
                    booleanOperator: index < elements.length - 1 ? booleanOp : null
                });
            });

            return criteria;
        }

        async function updateRule(ruleId) {
            const timeRange = document.getElementById('permanent-checkbox').checked
                ? { permanent: true }
                : {
                    permanent: false,
                    start: document.getElementById('range-start').value,
                    end: document.getElementById('range-end').value
                };

            const rule = {
                id: ruleId,
                created: new Date().toISOString(),
                criteria: buildCriteria(),
                timeRange
            };

            try {
                const response = await fetch(`/api/suppressions/${ruleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rule)
                });

                if (response.ok) {
                    loadSuppressionRules();
                    // Reset form
                    document.getElementById('criteria-container').innerHTML = '';
                    document.getElementById('permanent-checkbox').checked = false;
                    document.getElementById('range-start').value = '';
                    document.getElementById('range-end').value = '';
                } else {
                    throw new Error('Failed to update rule');
                }
            } catch (error) {
                console.error('Error updating suppression rule:', error);
                alert('Failed to update suppression rule');
            }
        }

        window.onload = () => {
            toggleTimeRange();
            loadIncidentDetails();
            loadSuppressionRules();
        };
    </script>
</head>

<body>
    <button class="back-btn" onclick="window.location.href='/'">Back to Incidents</button>
    <h1>Incident Details</h1>
    <table id="details" class="details-table"></table>
    <div id="suppression-management">
        <h3>Suppression Rules</h3>
        <div id="suppression-list"></div>
        <div id="suppression-builder">
            <h4>Create New Suppression</h4>
            <div id="criteria-container"></div>
            <div class="time-range">
                <label>
                    <input type="checkbox" id="permanent-checkbox" onchange="toggleTimeRange()">
                    Permanent Suppression
                </label>

                <div id="date-range-inputs">
                    <input type="date" id="range-start">
                    <input type="date" id="range-end">
                </div>
            </div>
            <button onclick="addCriterion()" class="btn">Add Criterion</button>
            <button onclick="saveSuppressionRule()" class="btn">Save Rule</button>
        </div>
    </div>
</body>

</html>